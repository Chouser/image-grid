<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>grid</title>
    <style type="text/css">
      html, head, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      canvas {
        display: block;
        top: 0;
        position: absolute;
      }
      div {
        text-align: center;
      }
      img {
        display: none;
      }
      #msg {
        position: absolute;
      }
    </style>
    <script type="text/javascript">//<![CDATA[

var hex = '0123456789ABCDEF'.split('');
var dec = {};
for( var i = 0; i < hex.length; ++i ) {
  dec[ hex[ i ] ] = i;
}

var ctx, img;

function drawGrid(ctx, ix, iy, d, xt, yt, xf, yf) {
  var x, y;
  for(x = ix % d - d; x < xf + xt + d; x += d) {
    for(y = iy % d - d; y < yf + yt + d; y += d) {
      ctx.beginPath();
      ctx.moveTo(x-xt,y);
      ctx.lineTo(x+xt+1,y);
      ctx.moveTo(x,y-yt);
      ctx.lineTo(x,y+yt+1);
      ctx.closePath();
      ctx.stroke();
    }
  }
}

var body;
var shade = 0;
var imgX = 0;
var imgY = 0;
var gridX = 0;
var gridY = 0;
var gridSize = 300;
var scale = 0.3;
var splitCount = 3;

function redraw() {
  ctx.clearRect(0, 0, body.offsetWidth, body.offsetHeight);
  ctx.save();
  ctx.translate( imgX, imgY );
  ctx.scale( scale, scale );

  ctx.drawImage(img, 0, 0);

  var x = hex[shade];
  ctx.strokeStyle = "#" + x + x + x + ";";
  drawGrid(ctx, gridX, gridY, gridSize,
           gridSize/2, gridSize/2, img.width, img.height);
  if(splitCount != 0) {
    drawGrid(ctx, gridX, gridY, gridSize/splitCount,
             gridSize/20, gridSize/20, img.width, img.height);
  }
  ctx.restore();
}

function drag(func) {
  body.onmousemove = function(e) {
    func(e);
    redraw();
  };

  body.onmouseup = function(e) {
    body.onmousemove = null;
    body.onmouseup = null;
    func(e);
    redraw();
  }
}

function resize() {
  img = document.getElementById('img');

  var c1 = document.getElementById('c1');
  c1.width = body.offsetWidth;
  c1.height = body.offsetHeight;

  ctx = c1.getContext("2d");

  redraw();
}

window.onload = function() {
  body = document.body;
  body.onclick = redraw;

  body.onmousedown = function(e) {
    var startX = e.clientX;
    var startY = e.clientY;

    if(e.ctrlKey) {
      if(e.shiftKey) {
        // scale grid
        var oldGridSize = gridSize;
        drag(function(e) {
            var delta = e.clientX - startX + e.clientY - startY;
            gridSize = oldGridSize + delta;
            if(gridSize < 3 || img.height / gridSize > 20)
              gridSize = Math.round(img.height / 20);
        });
      }
      else {
        // scale everything
        var oldScale = scale;
        var oldImgX = imgX;
        var oldImgY = imgY;
        drag(function(e) {
            var delta = e.clientX - startX + e.clientY - startY;
            scale = oldScale + delta * 0.001;
            imgX = startX - (startX - oldImgX) * scale / oldScale;
            imgY = startY - (startY - oldImgY) * scale / oldScale;
        });
      }
    }
    else {
      if(e.shiftKey) {
        // drag grid
        var oldGridX = gridX;
        var oldGridY = gridY;
        drag(function(e) {
          gridX = oldGridX + (e.clientX - startX) / scale;
          gridY = oldGridY + (e.clientY - startY) / scale;
        });
      }
      else {
        // drag everything
        var baseX = imgX - startX;
        var baseY = imgY - startY;
        drag(function(e) {
          imgX = baseX + e.clientX;
          imgY = baseY + e.clientY;
        });
      }
    }
  };

  body.onkeypress = function(e) {
    // shade = Math.round(16 / (e.keyCode - 48));
    if(e.keyCode >= 48)
      if(e.keyCode <= 58)
        splitCount = e.keyCode - 48;
    redraw();
  };

  body.onkeydown = function(e) {
    var dx = e.keyCode == 37 ? -1 : e.keyCode == 39 ? 1 : 0;
    var dy = e.keyCode == 38 ? -1 : e.keyCode == 40 ? 1 : 0;
    if(e.shiftKey) {
      gridX += dx / scale;
      gridY += dy / scale;
    }
    else {
      imgX += dx / scale;
      imgY += dy / scale;
    }
    redraw();
  }

  resize();
};

window.onresize = resize;

//]]>
    </script>
  </head>

  <body>
    <img id="img" src="2006.08.17-09150.jpg" />
    <canvas id="c1"></canvas>
    <div id="msg"></div>
  </body>
</html>

