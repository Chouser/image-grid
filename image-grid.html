<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>grid</title>
    <style type="text/css">
      html, head, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      canvas {
        display: block;
        top: 0;
        position: absolute;
      }
      div {
        text-align: center;
      }
      img {
        display: none;
      }
      #msg {
        position: absolute;
      }
    </style>
    <script type="text/javascript">//<![CDATA[

var hex = '0123456789ABCDEF'.split('');
var dec = {};
for( var i = 0; i < hex.length; ++i ) {
  dec[ hex[ i ] ] = i;
}

var c1, ctx;

function drawGrid(ctx, ix, iy, d, xt, yt, xf, yf) {
  var x, y;
  for(x = ix; x < xf + xt; x += d) {
    for(y = iy; y < yf + yt; y += d) {
      ctx.moveTo(x-xt,y);
      ctx.lineTo(x+xt+1,y);
      ctx.moveTo(x,y-yt);
      ctx.lineTo(x,y+yt+1);
    }
  }
}

var body;
var shade = 0;
var imgX = 0;
var imgY = 0;
var gridX = 0;
var gridY = 0;
var scale = 0.3;
var splitCount = 3;

function redraw() {
  var img = document.getElementById('img');

  c1 = document.getElementById('c1');
  c1.width = body.offsetWidth;
  c1.height = body.offsetHeight;
  ctx = c1.getContext("2d");

  ctx.translate( imgX, imgY );
  ctx.scale( scale, scale );

  ctx.drawImage(document.getElementById('img'), 0, 0);

  ctx.beginPath();
  drawGrid(ctx, gridX, gridY, 300, 50, 50, img.width, img.height);
  if(splitCount != 0) {
    drawGrid(ctx, gridX, gridY, 300/splitCount, 10, 10, img.width, img.height);
  }
  ctx.closePath();
  var x = hex[shade];
  ctx.strokeStyle = "#" + x + x + x + ";";
  ctx.stroke();
}

window.onload = function() {
  body = document.body;
  body.onclick = redraw;

  body.onmousedown = function(e) {
    if(e.shiftKey) {
      var oldGridX = gridX;
      var oldGridY = gridY;
      var startX = e.clientX;
      var startY = e.clientY;

      function updateGrid(e) {
        gridX = oldGridX + (e.clientX - startX) / scale;
        gridY = oldGridY + (e.clientY - startY) / scale;
        redraw();
      }

      body.onmousemove = function(e) {
        updateGrid(e);
      };

      body.onmouseup = function(e) {
        updateGrid(e);
        body.onmousemove = null;
        body.onmouseup = null;
      }
    }
    else {
      var baseX = imgX - e.clientX;
      var baseY = imgY - e.clientY;

      function updateImg(e) {
        imgX = baseX + e.clientX;
        imgY = baseY + e.clientY;
        redraw();
      }

      body.onmousemove = function(e) {
        updateImg(e);
      };

      body.onmouseup = function(e) {
        updateImg(e);
        body.onmousemove = null;
        body.onmouseup = null;
      }
    }
  };

  body.onkeypress = function(e) {
    if(e.keyCode >= 48)
      if(e.keyCode <= 58)
        splitCount = e.keyCode - 48;
    redraw();
  };

  redraw();
};

//]]>
    </script>
  </head>

  <body>
    <img id="img" src="2006.08.17-09150.jpg" />
    <canvas id="c1"></canvas>
    <div id="msg"></div>
  </body>
</html>

